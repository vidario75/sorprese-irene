<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sorpresa</title>
<meta name="theme-color" content="#e5e7eb"/>
<style>
  :root{--bg1:#f3f4f6;--bg2:#e5e7eb}
  *{box-sizing:border-box} html,body{margin:0;padding:0}
  body{
    min-height:100vh;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#111;padding:16px
  }
  .card{width:100%;max-width:520px;background:#fff;border-radius:22px;padding:24px;border:1px solid #eee;box-shadow:0 10px 30px rgba(0,0,0,.12)}
  .badge{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;font-size:12px;margin-bottom:8px}
  h1{margin:.25rem 0 .5rem;font-size:28px}
  p{margin:.25rem 0 1rem;line-height:1.6}
  .locked{border:2px dashed #cbd5e1;background:#f8fafc;border-radius:12px;padding:14px;margin-top:8px}
  .ok{background:#ecfeff;border:1px solid #a5f3fc;border-radius:12px;padding:12px}
  .hint{font-size:12px;opacity:.7}
  #title-real{display:none} #title-generic{display:block}
  .unlocked #title-real{display:block} .unlocked #title-generic{display:none}
</style>
</head>
<body>
<main id="card" class="card">
  <span class="badge">Sorpresa</span>
  <h1 id="title-generic">üéÅ C‚Äô√® una sorpresa!</h1>
  <h1 id="title-real"></h1>

  <div id="content" hidden>
    <div class="ok">
      <p><strong>√à fatta!</strong> Questa √® la tua sorpresa ü•∞</p>
      <p id="desc">Preparati: sar√† speciale.</p>
    </div>
    <p class="hint">Conserva questo bigliettino: servir√† per sbloccarne un altro.</p>
  </div>

  <div id="locked" class="locked" hidden>
    <p>üîí Questa sorpresa √® bloccata per ora.</p>
    <p class="hint">Quando l‚Äôorganizzatore ti dar√† un <em>QR staff</em>, torna qui e ricarica.</p>
  </div>

  <p class="hint">ID: <span id="pid"></span> ‚Ä¢ <span id="pageinfo">Sorpresa bloccata</span></p>
</main>

<script>
  // >>> CONFIG <<<
  const API_BASE  = "https://script.google.com/macros/s/AKfycbxr8qtzUH2UsrFETNweEcIEos5QFjUBN5nS9FTzMzTGkLO3GGV7j_ZPSqHyAkVArEsx-A/exec";
  const PLAYER_ID = "IRENE01";

  // DOM refs
  const card      = document.getElementById('card');
  const content   = document.getElementById('content');
  const locked    = document.getElementById('locked');
  const pid       = document.getElementById('pid');
  const pageinfo  = document.getElementById('pageinfo');
  const titleReal = document.getElementById('title-real');

  pid.textContent = PLAYER_ID;

  const params = new URLSearchParams(location.search);
  const KEY = (params.get('k') || "").trim();

  // UI helpers
  function showLoading(){
    document.title = "Sorpresa";
    pageinfo.textContent = "Verifica in corso‚Ä¶";
    card.classList.remove('unlocked');
    content.hidden = true;
    locked.hidden  = false;
    const p = locked.querySelector('p');
    if (p) p.textContent = "‚è≥ Verifica in corso‚Ä¶";
  }
  function showLocked(){
    document.title = "Sorpresa";
    pageinfo.textContent = "Sorpresa bloccata";
    card.classList.remove('unlocked');
    content.hidden = true;
    locked.hidden  = false;
    const p = locked.querySelector('p');
    if (p) p.textContent = "üîí Questa sorpresa √® bloccata per ora.";
  }
  function showUnlocked(title){
    document.title = title;
    titleReal.textContent = title;
    pageinfo.textContent = title;
    card.classList.add('unlocked');
    content.hidden = false;
    locked.hidden  = true;
  }

  async function checkOnce(){
    const url = `${API_BASE}?action=checkopen_by_key&id=${encodeURIComponent(PLAYER_ID)}&key=${encodeURIComponent(KEY)}&_=${Date.now()}`;
    const r = await fetch(url, { cache:'no-store' });
    return r.json();
  }

  let checking = false;
  async function check(){
    if (checking) return;
    checking = true;
    showLoading();
    if (!KEY){ showLocked(); checking=false; return; }
    try{
      const js = await checkOnce();
      if (js && js.ok && js.allowed){
        showUnlocked(js.title || "Sorpresa");
      } else {
        showLocked();
      }
    } catch(e){
      showLocked();
    } finally {
      checking = false;
    }
  }

  // Avvio ‚Äúrobusto‚Äù contro bfcache/ritorni
  check();                                 // normale page load
  window.addEventListener('pageshow', () => { check(); });          // ritorno da bfcache
  document.addEventListener('visibilitychange', () => {             // scheda torna visibile
    if (document.visibilityState === 'visible') check();
  });
</script>

</body>
</html>
